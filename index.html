<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Generator • Secure Redirect</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    :root{
      --bg: #0b0e14; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --brand:#7c3aed; --brand-2:#22d3ee; --danger:#ef4444; --ok:#22c55e;
      --ring: rgba(124,58,237,.5);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font: 15px/1.5 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text); background: radial-gradient(1200px 600px at 10% 10%, rgba(124,58,237,.15), transparent 50%),
                 radial-gradient(800px 500px at 90% 0%, rgba(34,211,238,.12), transparent 60%),
                 linear-gradient(180deg, #0a0f1f 0%, #0b0e14 100%);
    }
    a{color:var(--brand)}
    .container{max-width:1080px;margin:0 auto;padding:24px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .logo{display:flex;gap:10px;align-items:center;font-weight:700}
    .badge{padding:2px 8px;border-radius:999px;background:rgba(124,58,237,.15); color:#d6b2ff; border:1px solid rgba(124,58,237,.25); font-size:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .grid{display:grid; gap:16px}
    @media(min-width:900px){ .grid{grid-template-columns: 1.2fr .8fr} }
    .input, select, textarea{width:100%; background:#0d1220; color:var(--text); border:1px solid rgba(148,163,184,.25); padding:12px 14px; border-radius:12px; outline:none; transition:.2s}
    .input:focus, select:focus, textarea:focus{border-color:var(--brand); box-shadow:0 0 0 4px var(--ring)}
    label{display:block; font-size:12px; letter-spacing:.02em; text-transform:uppercase; color:var(--muted); margin:10px 0 6px}
    .row{display:flex; gap:12px; align-items:center}
    .btn{cursor:pointer; background:linear-gradient(135deg, var(--brand), var(--brand-2)); color:#fff; border:0; padding:12px 16px; border-radius:12px; font-weight:600; box-shadow:0 8px 25px rgba(124,58,237,.35); transition:.2s; text-decoration:none; display:inline-flex; gap:8px; align-items:center}
    .btn:disabled{opacity:.6; filter:grayscale(.2); cursor:not-allowed}
    .btn.secondary{background:#0d1220; color:var(--text); border:1px solid rgba(148,163,184,.3); box-shadow:none}
    .btn.danger{background: #7f1d1d}
    .muted{color:var(--muted)}
    .qrbox{display:flex; align-items:center; justify-content:center; min-height:260px; background:#0d1220; border:1px dashed rgba(148,163,184,.3); border-radius:16px}
    .hidden{display:none !important}
    .toast{position:fixed; right:18px; bottom:18px; padding:12px 16px; background:#111827; border:1px solid rgba(255,255,255,.08); color:#e5e7eb; border-radius:12px; box-shadow:0 10px 20px rgba(0,0,0,.35)}
    .code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0d1220; padding:8px 10px; border-radius:8px; border:1px solid rgba(148,163,184,.2); max-width:100%; overflow:hidden; text-overflow:ellipsis; display:inline-block; vertical-align:bottom}
    .iconbtn{padding:10px 12px; width:44px; justify-content:center}
    .iconbtn svg{pointer-events:none;}
    .center{display:flex; align-items:center; justify-content:center; min-height:60vh}
    .pwbox{max-width:420px; width:100%}
    #where{display:none}
    body.password-view-active .topbar{display:none}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="logo">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="4" stroke="#a78bfa" stroke-width="2"/><path d="M7 7h3M14 7h3M7 14h3M14 14h3M7 10h3M14 10h3M7 17h3M14 17h3" stroke="#22d3ee" stroke-width="2" stroke-linecap="round"/></svg>
        <span>Secure QR Generator</span>
        <span class="badge">AES‑GCM</span>
      </div>
      <div class="row">
        <span id="where" class="muted"></span>
      </div>
    </div>

    <div id="view-admin-login" class="hidden center">
      <div class="card pwbox">
        <label for="admin-pw">Admin‑Passwort</label>
        <input id="admin-pw" class="input" type="password" placeholder="••••••" />
        <div class="row" style="margin-top:12px">
          <button id="btn-admin-login" class="btn">Login</button>
        </div>
        <div id="admin-login-error" class="muted" style="color:var(--danger); margin-top:8px"></div>
      </div>
    </div>

    <div id="view-admin" class="hidden">
      <div class="card" style="margin-bottom:16px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:20px; font-weight:800">Mission Control</div>
            <div class="muted">Erstelle und verwalte sichere Weiterleitungs‑QR‑Codes.</div>
          </div>
          <div class="row">
            <button class="btn secondary" id="btn-change-admin">Admin‑Passwort setzen</button>
            <button class="btn danger" id="btn-logout">Logout</button>
          </div>
        </div>
      </div>
      <div class="grid">
        <div class="card">
          <div style="font-weight:700; font-size:16px; margin-bottom:6px">Neuen QR‑Code erstellen</div>

          <label for="genBase">URL dieses Generators</label>
          <input id="genBase" class="input" placeholder="https://deine-domain.tld/qr" />

          <label for="target">Ziel‑URL</label>
          <input id="target" class="input" placeholder="https://ziel.tld/pfad" />

          <div class="row">
            <div style="flex:1">
              <label for="needPw">Passwortschutz</label>
              <select id="needPw" class="input">
                <option value="no">Nein</option>
                <option value="yes">Ja</option>
              </select>
            </div>
            <div style="flex:1">
              <label for="pw">Passwort (falls aktiviert)</label>
              <input id="pw" class="input" type="text" placeholder="••••••" />
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label for="expire">Ablaufdatum (optional)</label>
              <input id="expire" class="input" type="datetime-local" />
            </div>
            <div style="flex:1">
              <label for="theme">QR‑Stil</label>
              <select id="theme" class="input">
                <option value="light">Hell</option>
                <option value="dark" selected>Dunkel</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="btn-generate" class="btn">Link & QR generieren</button>
            <button id="btn-copy" class="btn secondary " disabled aria-label="Link kopieren" title="Link kopieren">Link kopieren<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="9" y="9" width="10" height="12" rx="2" stroke="#94a3b8" stroke-width="2"/><rect x="5" y="3" width="10" height="12" rx="2" stroke="#94a3b8" stroke-width="2"/></svg></button>
          </div>

          <div id="out-link-row" style="margin-top:14px" class="muted"><span class="code" id="out-link">—</span></div>
        </div>
        <div class="card">
          <div style="font-weight:700; font-size:16px; margin-bottom:6px">Live‑Vorschau</div>
          <div class="qrbox"><div id="qrcode"></div></div>
          <div class="row" style="margin-top:12px; gap:12px; align-items:center">
            <div class="row" style="gap:8px">
              <label for="dl-size" style="margin:0">Größe</label>
              <input id="dl-size" class="input" type="number" min="128" step="64" value="512" style="width:110px" />
            </div>
            <div style="flex:1"></div>
            <div class="row" style="gap:8px">
              <button id="btn-dl-png" class="btn secondary">PNG</button>
              <button id="btn-dl-jpg" class="btn secondary">JPG</button>
              <button id="btn-dl-webp" class="btn secondary">WEBP</button>
              <button id="btn-dl-svg" class="btn secondary">SVG</button>
            </div>
          </div>
          <div class="muted" style="margin-top:10px">Scannen führt zum Generator mit verschlüsseltem Payload. Nur diese App kann entschlüsseln.</div>
        </div>
      </div>
    </div>

    <div id="view-password" class="hidden center">
      <div class="card pwbox">
        <div style="font-size:18px; font-weight:800; margin-bottom:4px">Passwort erforderlich</div>
        <div class="muted" id="pw-msg">Dieser Link ist geschützt. Bitte Passwort eingeben, um fortzufahren.</div>
        <label for="in-pw" style="margin-top:12px">Passwort</label>
        <input id="in-pw" class="input" type="password" placeholder="••••••" />
        <div class="row" style="margin-top:12px">
          <button id="btn-open" class="btn">Öffnen</button>
        </div>
        <div id="pw-error" class="muted" style="color:var(--danger); margin-top:8px"></div>
      </div>
    </div>

    <div id="view-landing" class="center">
      <div class="card pwbox">
        <div style="font-size:18px; font-weight:800; margin-bottom:4px">Secure QR Generator</div>
        <div class="muted">Scanne einen generierten QR‑Code oder öffne einen Link mit Parameter <span class="code">?r=...</span>.</div>
        <div class="muted" style="margin-top:10px">Admin‑Bereich erreichbar unter <span class="code">/#/missioncontrol</span>.</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script src="./qrcode.min.js"></script>

  <script src="./qrcode.min.js"></script>
  <script>
  /* ============================ Config ============================ */
  const DEFAULT_ADMIN_PASS_SHA256 = "8d7604e6ce893ea5d5b4091c3940b05164d900dca90873d6d2fc3356d4918bab"; // sha256("admin")
  const APP_MASTER_SECRET = "71997e1c9b1e99e2bd6204f8491cb48499f7b7f3d3f3da37abc2dfcef6b91e4e9d59316a2b546284f33b220afa99a021ca890f6b4bb0ea00c17b1acb11f21059";
  const KEY_DERIVE_SALT = new TextEncoder().encode("qrtool-v1-salt");
  const AES_GCM_TAGLEN = 96; // kürzerer Tag -> kürzerer Token
  
  /* ============================ Utils ============================ */
  const te = new TextEncoder();
  const td = new TextDecoder();
  const $  = (sel) => document.querySelector(sel);
  const show = (id) => { $(id).classList.remove('hidden'); };
  const hide = (id) => { $(id).classList.add('hidden'); };
  function notify(msg){ const t=$('#toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2200); }
  
  function toHex(buf){ return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  function fromHex(hex){ const bytes=new Uint8Array(hex.length/2); for(let i=0;i<bytes.length;i++){bytes[i]=parseInt(hex.substr(i*2,2),16)}; return bytes.buffer; }
  function b64url(bytes){ let str = btoa(String.fromCharCode(...new Uint8Array(bytes))); return str.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
  function fromB64url(b64){ b64=b64.replace(/-/g,'+').replace(/_/g,'/'); const pad = b64.length%4 ? '='.repeat(4-(b64.length%4)) : ''; const bin = atob(b64+pad); const arr = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr.buffer; }
  
  async function sha256Hex(str){ const h = await crypto.subtle.digest('SHA-256', te.encode(str)); return toHex(h); }
  async function deriveKey(master){
    const baseKey = await crypto.subtle.importKey('raw', te.encode(master), {name:'PBKDF2'}, false, ['deriveKey']);
    return await crypto.subtle.deriveKey({name:'PBKDF2', salt: KEY_DERIVE_SALT, iterations: 120_000, hash:'SHA-256'}, baseKey, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
  }
  function now(){ return Date.now(); }
  function getStoredAdminHash(){ return localStorage.getItem('qrtool_admin_hash') || DEFAULT_ADMIN_PASS_SHA256; }
  function randBytes(n){ const b=new Uint8Array(n); crypto.getRandomValues(b); return b; }
  
  /* ============================ Kompression (LZ fallback) ============================ */
  /* LZ-String 1.4.4 (trimmed to Uint8 helpers) */
  var LZString=(function(){var f=String.fromCharCode;var LZString={compressToUint8Array:function(e){var t=LZString._compress(e,16,function(e){return f(e)}),n=new Uint8Array(2*t.length);for(var r=0,o=t.length;r<o;r++){var a=t.charCodeAt(r);n[2*r]=a>>>8,n[2*r+1]=a%256}return n},decompressFromUint8Array:function(e){if(e===null||e===undefined)return LZString.decompress(e);for(var t=new Array(e.length/2),n=0,r=t.length;n<r;n++)t[n]=e[2*n]*256+e[2*n+1];var o=[];t.forEach(function(e){o.push(f(e))});var a=o.join('');return LZString._decompress(a.length,32768,function(e){return a.charCodeAt(e)})},_compress:function(o,e,t){if(o==null)return"";var n,r,i={},s={},p="",u="",c="",a=2,l=3,h=2,d=[],v=0,g=0;for(r=0;r<o.length;r+=1)if(p=o.charAt(r),Object.prototype.hasOwnProperty.call(i,p)||(i[p]=l++,s[p]=!0),u=c+p,Object.prototype.hasOwnProperty.call(i,u))c=u;else{if(Object.prototype.hasOwnProperty.call(s,c)){if(c.charCodeAt(0)<256){for(n=0;n<h;n++)v<<=1,g==e-1?(g=0,d.push(t(v)),v=0):g++;for(r=c.charCodeAt(0),n=0;n<8;n++)v=v<<1|1&r,g==e-1?(g=0,d.push(t(v)),v=0):g++,r>>=1}else{for(r=1,n=0;n<h;n++)v=v<<1|r,g==e-1?(g=0,d.push(t(v)),v=0):g++,r=0;for(r=c.charCodeAt(0),n=0;n<16;n++)v=v<<1|1&r,g==e-1?(g=0,d.push(t(v)),v=0):g++,r>>=1}a--,0==a&&(a=Math.pow(2,h),h++),delete s[c]}else for(r=i[c],n=0;n<h;n++)v=v<<1|1&r,g==e-1?(g=0,d.push(t(v)),v=0):g++,r>>=1;a--,0==a&&(a=Math.pow(2,h),h++),i[u]=l++,c=String(p)}if(""!==c){if(Object.prototype.hasOwnProperty.call(s,c)){if(c.charCodeAt(0)<256){for(n=0;n<h;n++)v<<=1,g==e-1?(g=0,d.push(t(v)),v=0):g++;for(r=c.charCodeAt(0),n=0;n<8;n++)v=v<<1|1&r,g==e-1?(g=0,d.push(t(v)),v=0):g++,r>>=1}else{for(r=1,n=0;n<h;n++)v=v<<1|r,g==e-1?(g=0,d.push(t(v)),v=0):g++,r=0;for(r=c.charCodeAt(0),n=0;n<16;n++)v=v<<1|1&r,g==e-1?(g=0,d.push(t(v)),v=0):g++,r>>=1}a--,0==a&&(a=Math.pow(2,h),h++),delete s[c]}else for(r=i[c],n=0;n<h;n++)v=v<<1|1&r,g==e-1?(g=0,d.push(t(v)),v=0):g++,r>>=1;a--,0==a&&(a=Math.pow(2,h),h++)}for(r=2,n=0;n<h;n++)v=v<<1|1&r,g==e-1?(g=0,d.push(t(v)),v=0):g++,r>>=1;for(;;){if(v<<=1,g==e-1){d.push(t(v));break}g++}return d.join("")},_decompress:function(e,t,n){var r,i,s,p,u,c,a,l,h,d=[],v=4,g=4,f=3,m="",w=[],x={val:n(0),position:t,index:1};for(i=0;i<3;i+=1)d[i]=i;for(p=0,c=Math.pow(2,2),a=1;a!=c;)u=x.val&x.position,x.position>>=1,0==x.position&&(x.position=t,x.val=n(x.index++)),p|=(u>0?1:0)*a,a<<=1;switch(p){case 0:for(p=0,c=Math.pow(2,8),a=1;a!=c;)u=x.val&x.position,x.position>>=1,0==x.position&&(x.position=t,x.val=n(x.index++)),p|=(u>0?1:0)*a,a<<=1;h=f(d[3]=m=f(p));break;case 1:for(p=0,c=Math.pow(2,16),a=1;a!=c;)u=x.val&x.position,x.position>>=1,0==x.position&&(x.position=t,x.val=n(x.index++)),p|=(u>0?1:0)*a,a<<=1;h=f(d[3]=m=f(p));break;case 2:return""}for(s=h,w.push(h);;){if(x.index>e)return"";for(p=0,c=Math.pow(2,g),a=1;a!=c;)u=x.val&x.position,x.position>>=1,0==x.position&&(x.position=t,x.val=n(x.index++)),p|=(u>0?1:0)*a,a<<=1;switch(h=p){case 0:for(p=0,c=Math.pow(2,8),a=1;a!=c;)u=x.val&x.position,x.position>>=1,0==x.position&&(x.position=t,x.val=n(x.index++)),p|=(u>0?1:0)*a,a<<=1;d[v++]=f(p),h=v-1,g--;break;case 1:for(p=0,c=Math.pow(2,16),a=1;a!=c;)u=x.val&x.position,x.position>>=1,0==x.position&&(x.position=t,x.val=n(x.index++)),p|=(u>0?1:0)*a,a<<=1;d[v++]=f(p),h=v-1,g--;break;case 2:return w.join("")}if(0==v&&(v=Math.pow(2,g),g++),d[h])m=d[h];else{if(h!==v)return null;m=s+m.charAt(0)}w.push(m),d[v++]=s+m.charAt(0),s=m,0==v&&(v=Math.pow(2,g),g++)}},decompress:function(e){return e==null?"":LZString._decompress(e.length,32768,function(t){return e.charCodeAt(t)})}};return LZString;}());
  
  /* ============================ Crypto with compression header ============================ */
  // Header: 0=none, 1=deflate-raw, 2=LZString
  async function encryptPayload(obj){
    const key = await deriveKey(APP_MASTER_SECRET);
    const iv  = crypto.getRandomValues(new Uint8Array(12));
    const jsonStr = JSON.stringify(obj);
  
    let method = 0, bodyU8;
    if (typeof CompressionStream !== 'undefined' && typeof DecompressionStream !== 'undefined'){
      const cs = new CompressionStream('deflate-raw');
      const w = cs.writable.getWriter(); w.write(te.encode(jsonStr)); w.close();
      const ab = await new Response(cs.readable).arrayBuffer();
      bodyU8 = new Uint8Array(ab); method = 1;
    } else {
      bodyU8 = LZString.compressToUint8Array(jsonStr); method = 2;
    }
  
    const plain = new Uint8Array(1 + bodyU8.length);
    plain[0] = method; plain.set(bodyU8, 1);
  
    const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv, tagLength: AES_GCM_TAGLEN}, key, plain);
    const out = new Uint8Array(iv.byteLength + ct.byteLength);
    out.set(iv,0); out.set(new Uint8Array(ct), iv.byteLength);
    return b64url(out);
  }
  async function decryptPayload(b64){
    const bytes = new Uint8Array(fromB64url(b64));
    const iv = bytes.slice(0,12); const ct = bytes.slice(12);
    const key = await deriveKey(APP_MASTER_SECRET);
    const pt  = await crypto.subtle.decrypt({name:'AES-GCM', iv, tagLength: AES_GCM_TAGLEN}, key, ct);
  
    const u8 = new Uint8Array(pt);
    const method = u8[0] || 0;
    const body   = u8.slice(1);
  
    if (method === 1){
      if (typeof DecompressionStream === 'undefined') throw new Error('Dekomprimierung (deflate) nicht verfügbar');
      const ds = new DecompressionStream('deflate-raw');
      const w = ds.writable.getWriter(); w.write(body); w.close();
      const ab = await new Response(ds.readable).arrayBuffer();
      return JSON.parse(td.decode(new Uint8Array(ab)));
    } else if (method === 2){
      return JSON.parse(LZString.decompressFromUint8Array(body));
    } else {
      return JSON.parse(td.decode(body));
    }
  }
  
  /* ============================ Password (short) ============================ */
  async function hashPasswordWithSalt(pw, saltBytes){
    if (!saltBytes) saltBytes = randBytes(8);           // 64-bit Salt
    const pwU8 = te.encode(pw);
    const data = new Uint8Array(saltBytes.length + pwU8.length);
    data.set(saltBytes,0); data.set(pwU8, saltBytes.length);
    const hFull = new Uint8Array(await crypto.subtle.digest('SHA-256', data));
    const hTrunc = hFull.slice(0,16);                   // 128-bit Hash
    return { s: b64url(saltBytes), h: b64url(hTrunc) };
  }
  async function verifyPassword(pw, pwObj){
    if(!pwObj) return true;
    const sStr = pwObj.s || pwObj.salt;         // new or legacy
    const hStr = pwObj.h || pwObj.hash;
    const salt = new Uint8Array(fromB64url(sStr));
    const exp  = new Uint8Array(fromB64url(hStr)); // stored length decides truncation
  
    const pwU8 = te.encode(pw);
    const data = new Uint8Array(salt.length + pwU8.length);
    data.set(salt,0); data.set(pwU8, salt.length);
    const hFull = new Uint8Array(await crypto.subtle.digest('SHA-256', data));
    const hTrunc = hFull.slice(0, exp.length);
    return b64url(hTrunc) === hStr;
  }
  
  /* ============================ QR helpers ============================ */
  let lastLink = null;
  async function renderPreview(link){
    lastLink = link;
    const box = document.querySelector('#qrcode');
    if(!box) return;
    box.innerHTML = '';
    const len = link.length;
    const size = len <= 160 ? 260 : len <= 280 ? 320 : len <= 420 ? 380 : 460;
    new window.QRCode(box, {
      text: link,
      width: size,
      height: size,
      colorDark: '#000000',
      colorLight: '#ffffff',
      correctLevel: window.QRCode.CorrectLevel.L
    });
  }
  async function downloadCanvas(canvas, filename, type){
    const blob = await new Promise(res=> canvas.toBlob(res, type));
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  async function buildCanvas(link, size){
    const tmp = document.createElement('div');
    tmp.style.position='absolute'; tmp.style.left='-9999px'; tmp.style.top='-9999px';
    document.body.appendChild(tmp);
    tmp.innerHTML='';
    new window.QRCode(tmp, { text: link, width: size, height: size, colorDark:'#000000', colorLight:'#ffffff', correctLevel: window.QRCode.CorrectLevel.L });
    const canvas = tmp.querySelector('canvas');
    document.body.removeChild(tmp);
    return canvas;
  }
  // simple SVG generator (keeps your SVG download button working)
  function SimpleQRToSVG(text, size=512, dark='#000000', light='#ffffff'){
    // Render via canvas then vectorize rectangles – simple and compact
    // (For perfect vector QR we’d reimplement encoder; this is good enough for export.)
    const n = 41; // version auto would be nicer; keep fixed grid for simplicity
    const cell = Math.floor(size / n);
    const pad  = Math.floor((size - cell*n)/2);
    // Use qrcode.js to get a matrix by rendering tiny canvas and reading pixels
    const tmp = document.createElement('div'); new window.QRCode(tmp,{text, width:n, height:n, colorDark:'#000', colorLight:'#fff', correctLevel:window.QRCode.CorrectLevel.L});
    const c = tmp.querySelector('canvas'); const ctx = c.getContext('2d'); const img = ctx.getImageData(0,0,n,n).data;
    let out = [`<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`];
    out.push(`<rect width="100%" height="100%" fill="${light}"/>`);
    for(let y=0;y<n;y++){ for(let x=0;x<n;x++){ const i=(y*n+x)*4; const isDark = img[i] < 128; if(isDark){ out.push(`<rect x="${pad+x*cell}" y="${pad+y*cell}" width="${cell}" height="${cell}" fill="${dark}"/>`); } } }
    out.push(`</svg>`); tmp.remove(); return out.join('');
  }
  async function downloadQR(fmt){
    if(!lastLink){ notify('Bitte zuerst einen Link generieren.'); return; }
    const sizeEl = document.getElementById('dl-size');
    const size = parseInt(sizeEl && sizeEl.value ? sizeEl.value : '512', 10);
    const name = 'qr';
    if(fmt==='svg'){
      const svgStr = SimpleQRToSVG(lastLink, size, '#000000', '#ffffff');
      const blob = new Blob([svgStr], {type:'image/svg+xml'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=name+'.svg'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      return;
    }
    const canvas = await buildCanvas(lastLink, size);
    if(fmt==='png') return downloadCanvas(canvas, name+'.png', 'image/png');
    if(fmt==='jpg') return downloadCanvas(canvas, name+'.jpg', 'image/jpeg');
    if(fmt==='webp') return downloadCanvas(canvas, name+'.webp', 'image/webp');
  }
  
  /* ============================ App Logic ============================ */
  function setupAdminLoginBindings(){
    const btn = document.getElementById('btn-admin-login');
    const inp = document.getElementById('admin-pw');
    const err = document.getElementById('admin-login-error');
    if(!btn || !inp) return;
    async function doLogin(){
      if(err) err.textContent='';
      const pw = inp.value || '';
      const hashHex = await sha256Hex(pw);
      const valid = (hashHex === getStoredAdminHash());
      if(valid){
        sessionStorage.setItem('admin_ok','1');
        location.replace(location.origin + location.pathname.replace(/\/$/,'') + '/#/missioncontrol');
      }else{
        if(err) err.textContent = 'Falsches Passwort.';
      }
    }
    btn.onclick = doLogin;
    inp.onkeydown = (e)=>{ if(e.key==='Enter') doLogin(); };
  }
  async function setupAdmin(){
    const base = location.origin + location.pathname.replace(/\/$/,'');
    $('#genBase').value = base || location.origin;
  
    $('#btn-change-admin').addEventListener('click', async ()=>{
      const newPw = prompt('Neues Admin-Passwort setzen'); if(!newPw) return;
      const h = await sha256Hex(newPw); localStorage.setItem('qrtool_admin_hash', h); sessionStorage.removeItem('admin_ok'); notify('Admin-Passwort aktualisiert.');
    });
    $('#btn-logout').addEventListener('click', ()=>{ sessionStorage.removeItem('admin_ok'); location.reload(); });
  
    $('#btn-generate').addEventListener('click', async ()=>{
      const genBase = $('#genBase').value.trim() || (location.origin + '/');
      const target = $('#target').value.trim();
      if(!/^https?:\/\//i.test(target)){ alert('Bitte eine gültige Ziel-URL angeben (https://...)'); return; }
      const needPw = $('#needPw').value === 'yes';
      const pw = $('#pw').value;
      if(needPw && !pw){ alert('Bitte Passwort angeben oder Passwortschutz deaktivieren.'); return; }
      let pwObj = null;
      if(needPw){ const hpw = await hashPasswordWithSalt(pw); pwObj = hpw; } // kurz
      const expStr = $('#expire').value; let expMs = null; if(expStr){ const d = new Date(expStr); if(!isNaN(d.getTime())) expMs = d.getTime(); }
      // Kompakter Payload: {v,t,p:{s,h},e}
      const payload = { v:1, t: target };
      if (pwObj) payload.p = pwObj;
      if (expMs) payload.e = expMs;
      try{
        const enc = await encryptPayload(payload);
        const link = genBase.replace(/\/$/,'') + '?r=' + enc;
        $('#out-link').textContent = '';
        $('#out-link').dataset.link = link;
        $('#btn-copy').disabled = false;
        const row = document.getElementById('out-link-row'); if(row) row.classList.add('hidden');
        await renderPreview(link);
        notify('Link generiert.');
      }catch(e){ console.error(e); alert('Fehler beim Erstellen des QR-Codes. (Verschlüsselung/Render) – Details in der Konsole.'); }
    });
  
    $('#btn-copy').addEventListener('click', async ()=>{
      const link = $('#out-link').dataset.link; if(!link) return;
      await navigator.clipboard.writeText(link); notify('In die Zwischenablage kopiert.');
    });
  
    document.getElementById('btn-dl-png').addEventListener('click', ()=>downloadQR('png'));
    document.getElementById('btn-dl-jpg').addEventListener('click', ()=>downloadQR('jpg'));
    document.getElementById('btn-dl-webp').addEventListener('click', ()=>downloadQR('webp'));
    document.getElementById('btn-dl-svg').addEventListener('click', ()=>downloadQR('svg'));
  }
  async function handleOpen(b64){
    try{
      const data = await decryptPayload(b64);
      if(data.e && now() > data.e){ document.body.innerHTML = '<div class="container center"><div class="card pwbox"><div style="font-size:18px;font-weight:800">Link abgelaufen</div><div class="muted">Dieses Ziel ist seit '+ new Date(data.e).toLocaleString() +' nicht mehr gültig.</div></div></div>'; return; }
      const target = data.t || data.tgt;
      const pwData = data.p || data.pwd;
      if(pwData){ // require password
        document.body.classList.add('password-view-active');
        hide('#view-landing'); hide('#view-admin'); show('#view-password');
        const btn = $('#btn-open'); const inp=$('#in-pw'); const err=$('#pw-error');
        async function tryOpen(){ err.textContent=''; const ok = await verifyPassword(inp.value, pwData); if(ok){ location.replace(target); } else { err.textContent = 'Falsches Passwort.'; } }
        btn.onclick = tryOpen; inp.onkeydown = (e)=>{ if(e.key==='Enter') tryOpen(); };
      } else {
        location.replace(target);
      }
    }catch(e){ console.error(e); document.body.innerHTML = '<div class="container center"><div class="card pwbox"><div style="font-size:18px;font-weight:800">Ungültiger oder beschädigter Link</div><div class="muted">Der übergebene Parameter konnte nicht entschlüsselt werden.</div></div></div>'; }
  }
  function init(){
    document.body.className = '';
    const u = new URL(location.href);
    const p = u.searchParams.get('r') || u.searchParams.get('p');
    const hash = location.hash;
    const path = location.pathname.replace(/\/$/,'');
  
    if (path.endsWith('/missioncontrol')) {
      const base = location.origin + location.pathname.replace(/\/missioncontrol\/?$/,'');
      history.replaceState(null, '', base + '/#/missioncontrol');
      return;
    }
  
    hide('#view-admin-login'); hide('#view-admin'); hide('#view-password'); hide('#view-landing');
  
    if (hash === '#/missioncontrol') {
      const loggedIn = sessionStorage.getItem('admin_ok') === '1';
      if (loggedIn) { show('#view-admin'); setupAdmin(); }
      else { show('#view-admin-login'); setupAdminLoginBindings(); }
    } else if (p) {
      handleOpen(p);
    } else {
      show('#view-landing');
    }
  }
  
  /* ============================ Self-Tests ============================ */
  async function selfTest(){
    try{
      // 1) Roundtrip (no password)
      const p1 = { v:1, t:'https://example.com', e: 1735689600000 };
      const enc1 = await encryptPayload(p1);
      const dec1 = await decryptPayload(enc1);
      console.assert(dec1.t === p1.t, 'RT no-pw failed');
  
      // 2) Roundtrip (password; new short format)
      const hpw = await hashPasswordWithSalt('secret');
      const p2 = { v:1, t:'https://example.com/a', p: hpw };
      const enc2 = await encryptPayload(p2);
      const dec2 = await decryptPayload(enc2);
      console.assert(await verifyPassword('secret', dec2.p), 'verify new pw failed');
  
      // 3) Legacy compatibility check (simulate old salt/hash keys)
      const legacy = { v:1, t:'https://example.org', pwd:{ salt: hpw.s, hash: hpw.h } };
      const enc3 = await encryptPayload(legacy);
      const dec3 = await decryptPayload(enc3);
      console.assert(await verifyPassword('secret', dec3.pwd), 'verify legacy pw failed');
  
      console.log('[SelfTest] OK – all');
    }catch(e){ console.warn('[SelfTest] FAILED', e); }
  }
  
  window.addEventListener('DOMContentLoaded', ()=>{ init(); selfTest(); });
  window.addEventListener('hashchange', init);
  </script>

  <!--
        ／＞　　フ
　　    | 　_　 _|
　  　／` ミ＿xノ
　　 /　　　　 |
　　/　 ヽ　　 ﾉ
　 │　　|　|　|
／￣|　　 |　|　|
(￣ヽ＿_ヽ_)__)
 ＼二つ
       Nycrofox
-->
  
</body>
</html>
