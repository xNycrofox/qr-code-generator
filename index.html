<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Generator • Secure Redirect</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    :root{
      --bg: #0b0e14; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --brand:#7c3aed; --brand-2:#22d3ee; --danger:#ef4444; --ok:#22c55e;
      --ring: rgba(124,58,237,.5);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font: 15px/1.5 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text); background: radial-gradient(1200px 600px at 10% 10%, rgba(124,58,237,.15), transparent 50%),
                 radial-gradient(800px 500px at 90% 0%, rgba(34,211,238,.12), transparent 60%),
                 linear-gradient(180deg, #0a0f1f 0%, #0b0e14 100%);
    }
    a{color:var(--brand)}
    .container{max-width:1080px;margin:0 auto;padding:24px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .logo{display:flex;gap:10px;align-items:center;font-weight:700}
    .badge{padding:2px 8px;border-radius:999px;background:rgba(124,58,237,.15); color:#d6b2ff; border:1px solid rgba(124,58,237,.25); font-size:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .grid{display:grid; gap:16px}
    @media(min-width:900px){ .grid{grid-template-columns: 1.2fr .8fr} }
    .input, select, textarea{width:100%; background:#0d1220; color:var(--text); border:1px solid rgba(148,163,184,.25); padding:12px 14px; border-radius:12px; outline:none; transition:.2s}
    .input:focus, select:focus, textarea:focus{border-color:var(--brand); box-shadow:0 0 0 4px var(--ring)}
    label{display:block; font-size:12px; letter-spacing:.02em; text-transform:uppercase; color:var(--muted); margin:10px 0 6px}
    .row{display:flex; gap:12px; align-items:center}
    .btn{cursor:pointer; background:linear-gradient(135deg, var(--brand), var(--brand-2)); color:#fff; border:0; padding:12px 16px; border-radius:12px; font-weight:600; box-shadow:0 8px 25px rgba(124,58,237,.35); transition:.2s; text-decoration:none; display:inline-flex; gap:8px; align-items:center}
    .btn:disabled{opacity:.6; filter:grayscale(.2); cursor:not-allowed}
    .btn.secondary{background:#0d1220; color:var(--text); border:1px solid rgba(148,163,184,.3); box-shadow:none}
    .btn.danger{background: #7f1d1d}
    .muted{color:var(--muted)}
    .qrbox{display:flex; align-items:center; justify-content:center; min-height:260px; background:#0d1220; border:1px dashed rgba(148,163,184,.3); border-radius:16px}
    .hidden{display:none !important}
    .toast{position:fixed; right:18px; bottom:18px; padding:12px 16px; background:#111827; border:1px solid rgba(255,255,255,.08); color:#e5e7eb; border-radius:12px; box-shadow:0 10px 20px rgba(0,0,0,.35)}
    .code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0d1220; padding:8px 10px; border-radius:8px; border:1px solid rgba(148,163,184,.2); max-width:100%; overflow:hidden; text-overflow:ellipsis; display:inline-block; vertical-align:bottom}
    .iconbtn{padding:10px 12px; width:44px; justify-content:center}
    .iconbtn svg{pointer-events:none;}
    .center{display:flex; align-items:center; justify-content:center; min-height:60vh}
    .pwbox{max-width:420px; width:100%}
    #where{display:none}
    body.password-view-active .topbar {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="logo">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="4" stroke="#a78bfa" stroke-width="2"/><path d="M7 7h3M14 7h3M7 14h3M14 14h3M7 10h3M14 10h3M7 17h3M14 17h3" stroke="#22d3ee" stroke-width="2" stroke-linecap="round"/></svg>
        <span>Secure QR Generator</span>
        <span class="badge">JS-only · AES‑GCM</span>
      </div>
      <div class="row">
        <span id="where" class="muted"></span>
      </div>
    </div>

    <div id="view-admin-login" class="hidden center">
      <div class="card pwbox">
        <label for="admin-pw">Admin‑Passwort</label>
        <input id="admin-pw" class="input" type="password" placeholder="••••••" />
        <div class="row" style="margin-top:12px">
          <button id="btn-admin-login" class="btn">Login</button>
        </div>
        <div id="admin-login-error" class="muted" style="color:var(--danger); margin-top:8px"></div>
      </div>
    </div>

    <div id="view-admin" class="hidden">
      <div class="card" style="margin-bottom:16px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:20px; font-weight:800">Mission Control</div>
            <div class="muted">Erstelle und verwalte sichere Weiterleitungs‑QR‑Codes.</div>
          </div>
          <div class="row">
            <button class="btn secondary" id="btn-change-admin">Admin‑Passwort setzen</button>
            <button class="btn danger" id="btn-logout">Logout</button>
          </div>
        </div>
      </div>
      <div class="grid">
        <div class="card">
          <div style="font-weight:700; font-size:16px; margin-bottom:6px">Neuen QR‑Code erstellen</div>

          <label for="genBase">URL dieses Generators</label>
          <input id="genBase" class="input" placeholder="https://deine-domain.tld/qr" />

          <label for="target">Ziel‑URL</label>
          <input id="target" class="input" placeholder="https://ziel.tld/pfad" />

          <div class="row">
            <div style="flex:1">
              <label for="needPw">Passwortschutz</label>
              <select id="needPw" class="input">
                <option value="no">Nein</option>
                <option value="yes">Ja</option>
              </select>
            </div>
            <div style="flex:1">
              <label for="pw">Passwort (falls aktiviert)</label>
              <input id="pw" class="input" type="text" placeholder="••••••" />
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label for="expire">Ablaufdatum (optional)</label>
              <input id="expire" class="input" type="datetime-local" />
            </div>
            <div style="flex:1">
              <label for="theme">QR‑Stil</label>
              <select id="theme" class="input">
                <option value="light">Hell</option>
                <option value="dark" selected>Dunkel</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="btn-generate" class="btn">Link & QR generieren</button>
            <button id="btn-copy" class="btn secondary " disabled aria-label="Link kopieren" title="Link kopieren">Link kopieren<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="9" y="9" width="10" height="12" rx="2" stroke="#94a3b8" stroke-width="2"/><rect x="5" y="3" width="10" height="12" rx="2" stroke="#94a3b8" stroke-width="2"/></svg></button>
          </div>

          <div id="out-link-row" style="margin-top:14px" class="muted"><span class="code" id="out-link">—</span></div>
        </div>
        <div class="card">
          <div style="font-weight:700; font-size:16px; margin-bottom:6px">Live‑Vorschau</div>
          <div class="qrbox"><div id="qrcode"></div></div>
          <div class="row" style="margin-top:12px; gap:12px; align-items:center">
            <div class="row" style="gap:8px">
              <label for="dl-size" style="margin:0">Größe</label>
              <input id="dl-size" class="input" type="number" min="128" step="64" value="512" style="width:110px" />
            </div>
            <div style="flex:1"></div>
            <div class="row" style="gap:8px">
              <button id="btn-dl-png" class="btn secondary">PNG</button>
              <button id="btn-dl-jpg" class="btn secondary">JPG</button>
              <button id="btn-dl-webp" class="btn secondary">WEBP</button>
              <button id="btn-dl-svg" class="btn secondary">SVG</button>
            </div>
          </div>
          <div class="muted" style="margin-top:10px">Scannen führt zum Generator mit verschlüsseltem Payload. Nur diese App kann entschlüsseln.</div>
        </div>
      </div>
    </div>

    <div id="view-password" class="hidden center">
      <div class="card pwbox">
        <div style="font-size:18px; font-weight:800; margin-bottom:4px">Passwort erforderlich</div>
        <div class="muted" id="pw-msg">Dieser Link ist geschützt. Bitte Passwort eingeben, um fortzufahren.</div>
        <label for="in-pw" style="margin-top:12px">Passwort</label>
        <input id="in-pw" class="input" type="password" placeholder="••••••" />
        <div class="row" style="margin-top:12px">
          <button id="btn-open" class="btn">Öffnen</button>
        </div>
        <div id="pw-error" class="muted" style="color:var(--danger); margin-top:8px"></div>
      </div>
    </div>

    <div id="view-landing" class="center">
      <div class="card pwbox">
        <div style="font-size:18px; font-weight:800; margin-bottom:4px">Secure QR Generator</div>
        <div class="muted">Scanne einen generierten QR‑Code oder öffne einen Link mit Parameter <span class="code">?r=...</span>.</div>
        <div class="muted" style="margin-top:10px">Admin‑Bereich erreichbar unter <span class="code">/#/missioncontrol</span>.</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script src="./qrcode.min.js"></script>

  <script>
  // ———————————————— Configuration ————————————————
  // Replace ADMIN_PASS_SHA256 to your own hash (hex) of your admin password.
  // You can also set/override it at runtime via the "Admin‑Passwort setzen" button (stored in localStorage).
  const DEFAULT_ADMIN_PASS_SHA256 = "8d7604e6ce893ea5d5b4091c3940b05164d900dca90873d6d2fc3356d4918bab"; // sha256("admin") as hex (demo!)
  // Master secret: used to derive an AES‑GCM key. Change this to your own long random string BEFORE deploying.
  const APP_MASTER_SECRET = "c6be483ed382a87dae3b484fb68840e2e43c247207ed147f00cebd02193aedf10f3cc1145141e4f06a9bff0925763d86d03b1e2b2feb1014384df26506f7715f";
  const KEY_DERIVE_SALT = new TextEncoder().encode("qrtool-v1-salt");
  const AES_GCM_TAGLEN = 128; // bits

  // ———————————————— Utilities ————————————————
  const te = new TextEncoder();
  const td = new TextDecoder();
  const $ = (sel) => document.querySelector(sel);
  const show = (id) => { $(id).classList.remove('hidden'); };
  const hide = (id) => { $(id).classList.add('hidden'); };
  function notify(msg){ const t=$('#toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2200); }

  function toHex(buf){ return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  function fromHex(hex){ const bytes=new Uint8Array(hex.length/2); for(let i=0;i<bytes.length;i++){bytes[i]=parseInt(hex.substr(i*2,2),16)}; return bytes.buffer; }
  function b64url(bytes){ let str = btoa(String.fromCharCode(...new Uint8Array(bytes))); return str.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
  function fromB64url(b64){ b64=b64.replace(/-/g,'+').replace(/_/g,'/'); const pad = b64.length%4 ? '='.repeat(4-(b64.length%4)) : ''; const bin = atob(b64+pad); const arr = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr.buffer; }

  async function sha256Hex(str){ const h = await crypto.subtle.digest('SHA-256', te.encode(str)); return toHex(h);
  }
  async function sha256Bytes(str){ return await crypto.subtle.digest('SHA-256', te.encode(str)); }

  async function deriveKey(master){
    const baseKey = await crypto.subtle.importKey('raw', te.encode(master), {name:'PBKDF2'}, false, ['deriveKey']);
    return await crypto.subtle.deriveKey({name:'PBKDF2', salt: KEY_DERIVE_SALT, iterations: 120_000, hash:'SHA-256'}, baseKey, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
  }

  async function encryptPayload(obj){
    const key = await deriveKey(APP_MASTER_SECRET);
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const data = te.encode(JSON.stringify(obj));
    const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv, tagLength: AES_GCM_TAGLEN}, key, data);
    // pack iv + ct
    const out = new Uint8Array(iv.byteLength + ct.byteLength);
    out.set(iv,0); out.set(new Uint8Array(ct), iv.byteLength);
    return b64url(out);
  }

  async function decryptPayload(b64){
    const bytes = new Uint8Array(fromB64url(b64));
    const iv = bytes.slice(0,12); const ct = bytes.slice(12);
    const key = await deriveKey(APP_MASTER_SECRET);
    const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv, tagLength: AES_GCM_TAGLEN}, key, ct);
    return JSON.parse(td.decode(pt));
  }

  function now(){ return Date.now(); }

  function getStoredAdminHash(){ return localStorage.getItem('qrtool_admin_hash') || DEFAULT_ADMIN_PASS_SHA256; }
  async function requireAdmin(){
    const where=$('#where'); if(where) where.textContent = ''; 
    if(sessionStorage.getItem('admin_ok')==='1') return true;
    const input = prompt('Admin‑Passwort eingeben');
    if(!input) return false;
    const hashHex = await sha256Hex(input);
    const valid = (hashHex === getStoredAdminHash());
    if(valid){ sessionStorage.setItem('admin_ok','1'); return true; }
    alert('Falsches Passwort'); return false;
  }

  // Password hashing for protected links: store salt + hash(SALT || pw)
  function randBytes(n){ const b=new Uint8Array(n); crypto.getRandomValues(b); return b; }
  async function hashPasswordWithSalt(pw, saltBytes){
    const data = new Uint8Array(saltBytes.length + te.encode(pw).length);
    data.set(saltBytes,0); data.set(new Uint8Array(te.encode(pw)), saltBytes.length);
    const h = await crypto.subtle.digest('SHA-256', data);
    return { salt: b64url(saltBytes), hash: b64url(h), alg:'S256' };
  }
  async function verifyPassword(pw, pwObj){
    if(!pwObj) return true; // no password
    const salt = fromB64url(pwObj.salt);
    const data = new Uint8Array(salt.byteLength + te.encode(pw).length);
    data.set(new Uint8Array(salt),0); data.set(new Uint8Array(te.encode(pw)), salt.byteLength);
    const h = await crypto.subtle.digest('SHA-256', data);
    return b64url(h) === pwObj.hash;
  }

  // ———————————————— QR Code (embedded lib: QRCode.js by davidshimjs, MIT, trimmed) ————————————————
  /*! QRCode.js v1.0.0 (trimmed) */
  // Minimal embed to keep single-file; credits: https://github.com/davidshimjs/qrcodejs
  (function(){
    function QR8bitByte(data){this.mode=1;this.data=data;} QR8bitByte.prototype={getLength:function(){return this.data.length},write:function(buffer){for(var i=0;i<this.data.length;i++){buffer.put(this.data.charCodeAt(i),8)}}};
    var QRUtil={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54]],
    getBCHTypeInfo:function(data){var d=data<<10;while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(1335)>=0){d^=(1335<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(1335)))}return (data<<10|d)&0x7fff},
    getBCHDigit:function(data){var digit=0;while(data!=0){digit++;data>>>=1}return digit}};
    var QRMath={glog:function(n){if(n<1)throw new Error('glog('+n+')');return QRMath.LOG_TABLE[n]},gexp:function(n){while(n<0)n+=255;while(n>=256)n-=255;return QRMath.EXP_TABLE[n]},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)};for(var i=0;i<8;i++) QRMath.EXP_TABLE[i]=1<<i;for(var i=8;i<256;i++) QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];for(var i=0;i<256;i++) QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;
    function QRRSBlock(totalCount,dataCount){this.totalCount=totalCount;this.dataCount=dataCount}
    QRRSBlock.getRSBlocks=function(typeNumber){var rs=[[ [19,16] ], [ [34,28] ], [ [55,44] ], [ [80,64] ], [ [108,86] ], [ [136,108] ], [ [156,124] ], [ [194,154] ], [ [232,182] ], [ [274,216] ]]; var d=rs[typeNumber-1];var list=[]; for(var i=0;i<d.length;i++){var dc=d[i]; list.push(new QRRSBlock(dc[0],dc[1]));} return list; };
    function QRBitBuffer(){this.buffer=[];this.length=0} QRBitBuffer.prototype={get:function(i){return ((this.buffer[i>>3]>>(7-(i&7)))&1)==1},put:function(num,length){for(var i=0;i<length;i++){this.putBit(((num>>(length-i-1))&1)==1)}},putBit:function(bit){var bufIndex=this.length>>3; if(this.buffer.length<=bufIndex)this.buffer.push(0); if(bit)this.buffer[bufIndex]|=(0x80>>(this.length&7)); this.length++}};
    function QRCodeModel(typeNumber){this.typeNumber=typeNumber; this.modules=null; this.moduleCount=0; this.dataList=[]}
    QRCodeModel.prototype={addData:function(data){this.dataList.push(new QR8bitByte(data))},make:function(){this.moduleCount=this.typeNumber*4+17;this.modules=new Array(this.moduleCount);for(var row=0;row<this.moduleCount;row++){this.modules[row]=new Array(this.moduleCount);for(var col=0;col<this.moduleCount;col++){this.modules[row][col]=null}} this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);this.mapData(this.createData())},
      setupPositionProbePattern:function(row,col){for(var r=-1;r<=7;r++){if(row+r<=-1||this.moduleCount<=row+r)continue;for(var c=-1;c<=7;c++){if(col+c<=-1||this.moduleCount<=col+c)continue; this.modules[row+r][col+c]=(r>=0&&r<=6&&(c==0||c==6))||(c>=0&&c<=6&&(r==0||r==6))||(r>=2&&r<=4&&c>=2&&c<=4)} }},
      mapData:function(data){var inc=-1,row=this.moduleCount-1,bitIndex=7,byteIndex=0; for(var col=this.moduleCount-1; col>0; col-=2){if(col==6) col--; while(true){ for(var c=0;c<2;c++){ if(this.modules[row][col-c]==null){ var dark=false; if(byteIndex<data.length){ dark= ((data[byteIndex]>>>bitIndex)&1)==1; } this.modules[row][col-c]=dark; bitIndex--; if(bitIndex==-1){ byteIndex++; bitIndex=7; } } } row+=inc; if(row<0||this.moduleCount<=row){ row-=inc; inc=-inc; break; } } }},
      createData:function(){var buffer=new QRBitBuffer(); for(var i=0;i<this.dataList.length;i++){var data=this.dataList[i]; buffer.put(4,4); buffer.put(data.getLength(),8); for(var j=0;j<data.getLength();j++) buffer.put(data.data.charCodeAt(j),8);} var rsBlocks=QRRSBlock.getRSBlocks(this.typeNumber); var totalDataCount=0; for(var i=0;i<rsBlocks.length;i++) totalDataCount+=rsBlocks[i].dataCount; while(buffer.length+4<=totalDataCount*8) buffer.put(0,1); while(buffer.length%8!=0) buffer.put(0,1); var bytes=new Array(totalDataCount); for(var i=0;i<bytes.length;i++) bytes[i]=0; for(var i=0;i<buffer.length; i++){ bytes[i>>3]|=((buffer.get(i)?1:0)<<(7-(i&7))); } return bytes; }
    };
    window.SimpleQRCode = function(el, text, size=240, dark='#000', light='#fff'){
      var m = new QRCodeModel(4); m.addData(text); m.make(); var n=m.moduleCount; var c=document.createElement('canvas'); c.width=c.height=size; var ctx=c.getContext('2d'); var q=size/n; ctx.fillStyle=light; ctx.fillRect(0,0,size,size); ctx.fillStyle=dark; for(var r=0;r<n;r++){ for(var col=0;col<n;col++){ if(m.modules[r][col]) ctx.fillRect(Math.round(col*q), Math.round(r*q), Math.ceil(q), Math.ceil(q)); } } el.innerHTML=''; el.appendChild(c); return c; };

    // SVG generator based on QRCodeModel (for downloads)
    window.SimpleQRToSVG = function(text, size, dark, light){
      var m = new QRCodeModel(4); m.addData(text); m.make();
      var n = m.moduleCount; var q = size / n;
      var svg = ['<svg xmlns="http://www.w3.org/2000/svg" width="'+size+'" height="'+size+'" viewBox="0 0 '+size+' '+size+'">'];
      svg.push('<rect width="100%" height="100%" fill="'+(light||'#ffffff')+'"/>');
      var y=0; for(var r=0;r<n;r++){ var x=0; for(var c=0;c<n;c++){ if(m.modules[r][c]) svg.push('<rect x="'+Math.round(x)+'" y="'+Math.round(y)+'" width="'+Math.ceil(q)+'" height="'+Math.ceil(q)+'" fill="'+(dark||'#000000')+'"/>'); x+=q; } y+=q; }
      svg.push('</svg>');
      return svg.join('');
    };
  })();

  // ———————————————— App Logic ————————————————
  // Bindings for Admin Login view
  // Bindings for Admin Login view
  function setupAdminLoginBindings(){
    const btn = document.getElementById('btn-admin-login');
    const inp = document.getElementById('admin-pw');
    const err = document.getElementById('admin-login-error');
    if(!btn || !inp) return;

    async function doLogin(){
      if(err) err.textContent='';
      const pw = inp.value || '';
      const hashHex = await sha256Hex(pw);
      const valid = (hashHex === getStoredAdminHash());
      if(valid){
        sessionStorage.setItem('admin_ok','1');
        // ÄNDERUNG HIER: Statt location.replace, einfach den Hash ändern.
        // Das löst den 'hashchange' Event aus, der dann init() aufruft.
        location.hash = '#/missioncontrol';
        init()
      }else{
        if(err) err.textContent = 'Falsches Passwort.';
      }
    }
    btn.onclick = doLogin;
    inp.onkeydown = (e)=>{ if(e.key==='Enter') doLogin(); };
  }
  // Using local davidshimjs qrcode.min.js

  // Preview + Download helpers
  let lastLink = null; 
  let lastDark = false;
  async function renderPreview(link){
    const themeSel = document.querySelector('#theme');
    lastDark = (themeSel ? themeSel.value === 'dark' : true);
    lastLink = link;
    const box = document.querySelector('#qrcode');
    if(!box) return;
    box.innerHTML = '';
    // davidshimjs QRCode.js renders directly into container
    new window.QRCode(box, {
      text: link,
      width: 260,
      height: 260,
      colorDark: lastDark ? '#ffffff' : '#000000',
      colorLight: lastDark ? '#0d1220' : '#ffffff',
      correctLevel: window.QRCode.CorrectLevel.M
    });
  }
  async function downloadCanvas(canvas, filename, type){
    const blob = await new Promise(res=> canvas.toBlob(res, type));
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  async function buildCanvas(link, size){
    // Render in offscreen container and grab the <canvas>
    const tmp = document.createElement('div');
    tmp.style.position='absolute'; tmp.style.left='-9999px'; tmp.style.top='-9999px';
    document.body.appendChild(tmp);
    tmp.innerHTML='';
    new window.QRCode(tmp, {
      text: link,
      width: size,
      height: size,
      colorDark: lastDark ? '#ffffff' : '#000000',
      colorLight: lastDark ? '#0d1220' : '#ffffff',
      correctLevel: window.QRCode.CorrectLevel.M
    });
    const canvas = tmp.querySelector('canvas');
    document.body.removeChild(tmp);
    return canvas;
  }
  async function downloadQR(fmt){
    if(!lastLink){ notify('Bitte zuerst einen Link generieren.'); return; }
    const sizeEl = document.getElementById('dl-size');
    const size = parseInt(sizeEl && sizeEl.value ? sizeEl.value : '512', 10);
    const name = 'qr';
    if(fmt==='svg'){
      const svgStr = window.SimpleQRToSVG(
        lastLink,
        size,
        lastDark ? '#ffffff' : '#000000',
        lastDark ? '#0d1220' : '#ffffff'
      );
      const blob = new Blob([svgStr], {type:'image/svg+xml'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=name+'.svg'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      return;
    }
    const canvas = await buildCanvas(lastLink, size);
    if(fmt==='png') return downloadCanvas(canvas, name+'.png', 'image/png');
    if(fmt==='jpg') return downloadCanvas(canvas, name+'.jpg', 'image/jpeg');
    if(fmt==='webp') return downloadCanvas(canvas, name+'.webp', 'image/webp');
  }
  function init(){
    document.body.className = '';
    const u = new URL(location.href);
    const p = u.searchParams.get('r');
    const hash = location.hash;
    const path = location.pathname.replace(/\/$/,'');

    // Wenn jemand direkt /missioncontrol aufruft (z.B. http://localhost/qr/missioncontrol),
    // rewrite auf Hash-Route, damit es auch statisch funktioniert:
    if (path.endsWith('/missioncontrol')) {
      const base = location.origin + location.pathname.replace(/\/missioncontrol\/?$/,'');
      history.replaceState(null, '', base + '/#/missioncontrol');
      // Rufe init erneut auf, da sich der Hash geändert hat (wird durch 'hashchange' Event erledigt)
      return; 
    }

    // Zuerst alle Hauptansichten ausblenden für einen sauberen Start
    hide('#view-admin-login');
    hide('#view-admin');
    hide('#view-password');
    hide('#view-landing');

    // 1. Fall: Admin-Route
    if (hash === '#/missioncontrol') {
      const loggedIn = sessionStorage.getItem('admin_ok') === '1';
      if (loggedIn) {
        show('#view-admin');
        setupAdmin();
      } else {
        show('#view-admin-login');
        setupAdminLoginBindings();
      }
    // 2. Fall: QR-Link wird geöffnet
    } else if (p) {
      handleOpen(p);
    // 3. Fall: Standard-Ansicht (Landing-Page)
    } else {
      show('#view-landing');
    }
  }

  async function setupAdmin(){
    const base = location.origin + location.pathname.replace(/\/$/,'');
    $('#genBase').value = base || location.origin;

    $('#btn-change-admin').addEventListener('click', async ()=>{
      const newPw = prompt('Neues Admin‑Passwort setzen'); if(!newPw) return;
      const h = await sha256Hex(newPw); localStorage.setItem('qrtool_admin_hash', h); sessionStorage.removeItem('admin_ok'); notify('Admin‑Passwort aktualisiert.');
    });
    $('#btn-logout').addEventListener('click', ()=>{ sessionStorage.removeItem('admin_ok'); location.reload(); });

    $('#btn-generate').addEventListener('click', async ()=>{
      const genBase = $('#genBase').value.trim() || (location.origin + '/');
      const target = $('#target').value.trim();
      if(!/^https?:\/\//i.test(target)){ alert('Bitte eine gültige Ziel‑URL angeben (https://...)'); return; }
      const needPw = $('#needPw').value === 'yes';
      const pw = $('#pw').value;
      if(needPw && !pw){ alert('Bitte Passwort angeben oder Passwortschutz deaktivieren.'); return; }
      let pwObj = null;
      if(needPw){ pwObj = await hashPasswordWithSalt(pw, randBytes(16)); }
      const expStr = $('#expire').value; let expMs = null; if(expStr){ const d = new Date(expStr); if(!isNaN(d.getTime())) expMs = d.getTime(); }
      const payload = { v:1, tgt: target, pwd: pwObj, exp: expMs };
      try{
        const enc = await encryptPayload(payload);
        const link = genBase.replace(/\/$/,'') + '?r=' + enc;
        $('#out-link').textContent = '';
        $('#out-link').dataset.link = link;
        $('#btn-copy').disabled = false;
        const row = document.getElementById('out-link-row'); if(row) row.classList.add('hidden');
        await renderPreview(link);
        notify('Link generiert.');
      }catch(e){ console.error(e); alert('Fehler beim Erstellen des QR‑Codes. (Verschlüsselung/Render) – Details in der Konsole.'); }
    });

    $('#btn-copy').addEventListener('click', async ()=>{
      const link = $('#out-link').dataset.link; if(!link) return;
      await navigator.clipboard.writeText(link); notify('In die Zwischenablage kopiert.');
    });

    // Download Buttons
    document.getElementById('btn-dl-png').addEventListener('click', ()=>downloadQR('png'));
    document.getElementById('btn-dl-jpg').addEventListener('click', ()=>downloadQR('jpg'));
    document.getElementById('btn-dl-webp').addEventListener('click', ()=>downloadQR('webp'));
    document.getElementById('btn-dl-svg').addEventListener('click', ()=>downloadQR('svg'));
  }

  async function handleOpen(b64){
    try{
      const data = await decryptPayload(b64);
      if(data.exp && now() > data.exp){ document.body.innerHTML = '<div class="container center"><div class="card pwbox"><div style="font-size:18px;font-weight:800">Link abgelaufen</div><div class="muted">Dieses Ziel ist seit '+ new Date(data.exp).toLocaleString() +' nicht mehr gültig.</div></div></div>'; return; }
      if(data.pwd){ // require password
        document.body.classList.add('password-view-active');
        hide('#view-landing'); hide('#view-admin'); show('#view-password');
        const btn = $('#btn-open'); const inp=$('#in-pw'); const err=$('#pw-error');
        async function tryOpen(){ err.textContent=''; const ok = await verifyPassword(inp.value, data.pwd); if(ok){ location.replace(data.tgt); } else { err.textContent = 'Falsches Passwort.'; }
        }
        btn.onclick = tryOpen; inp.onkeydown = (e)=>{ if(e.key==='Enter') tryOpen(); };
      } else {
        // direct open
        location.replace(data.tgt);
      }
    }catch(e){ console.error(e); document.body.innerHTML = '<div class="container center"><div class="card pwbox"><div style="font-size:18px;font-weight:800">Ungültiger oder beschädigter Link</div><div class="muted">Der übergebene Parameter konnte nicht entschlüsselt werden.</div></div></div>'; }
  }

  window.addEventListener('DOMContentLoaded', init);
  window.addEventListener('hashchange', init);
  </script>

  <!--
        ／＞　　フ
　　    | 　_　 _|
　  　／` ミ＿xノ
　　 /　　　　 |
　　/　 ヽ　　 ﾉ
　 │　　|　|　|
／￣|　　 |　|　|
(￣ヽ＿_ヽ_)__)
 ＼二つ
       Nycrofox
-->
  
</body>
</html>
